{% extends 'pragmatic-cookies/_layout' %}

{% set title = 'Categories'|t('pragmatic-cookies') %}
{% set selectedTab = 'categories' %}
{% set _siteHandle = craft.app.request.getQueryParam('site') %}
{% set _siteParam = _siteHandle ? { site: _siteHandle } : {} %}

{% set crumbs = [
  { label: 'Cookies'|t('pragmatic-cookies'), url: url('pragmatic-cookies', _siteParam) },
  { label: 'Categories'|t('pragmatic-cookies'), url: url('pragmatic-cookies/categories', _siteParam) },
] %}

{% block content %}
  <div class="toolbar">
    <a href="{{ url('pragmatic-cookies/categories/new', _siteParam) }}" class="btn submit add icon">{{ 'New Category'|t('pragmatic-cookies') }}</a>
  </div>

  {% if categories|length %}
    <div class="tableview">
      <table class="data fullwidth">
        <thead>
          <tr>
            <th>{{ 'Name'|t('pragmatic-cookies') }}</th>
            <th>{{ 'Handle'|t('pragmatic-cookies') }}</th>
            <th>{{ 'Required'|t('pragmatic-cookies') }}</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="categories-table">
          {% for category in categories %}
            <tr data-id="{{ category.id }}">
              <td>
                <a href="{{ url('pragmatic-cookies/categories/' ~ category.id, _siteParam) }}">
                  {{ category.name }}
                </a>
              </td>
              <td><code>{{ category.handle }}</code></td>
              <td>
                {% if category.isRequired %}
                  <span class="status on"></span> {{ 'Yes'|t('pragmatic-cookies') }}
                {% else %}
                  <span class="status"></span> {{ 'No'|t('pragmatic-cookies') }}
                {% endif %}
              </td>
              <td class="thin">
                <a class="delete icon" title="{{ 'Delete'|t('pragmatic-cookies') }}" role="button" data-category-id="{{ category.id }}"></a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p>{{ 'No categories yet.'|t('pragmatic-cookies') }}</p>
  {% endif %}

  {% js %}
    document.querySelectorAll('.delete.icon[data-category-id]').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        if (!confirm({{ 'Are you sure you want to delete this category?'|t('pragmatic-cookies')|json_encode|raw }})) return;
        var id = this.dataset.categoryId;
        Craft.sendActionRequest('POST', 'pragmatic-cookies/default/delete-category', {
          data: { id: id }
        }).then(function() {
          location.reload();
        });
      });
    });
  {% endjs %}
{% endblock %}
