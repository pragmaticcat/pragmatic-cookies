{% extends 'pragmatic-cookies/_layout' %}

{% set title = 'Cookies'|t('pragmatic-cookies') %}
{% set selectedTab = 'cookies' %}

{% set crumbs = [
  { label: 'Cookies'|t('pragmatic-cookies'), url: url('pragmatic-cookies') },
  { label: 'Cookies'|t('pragmatic-cookies'), url: url('pragmatic-cookies/cookies') },
] %}

{% block content %}
  <div class="toolbar">
    <button class="btn submit add icon" id="new-cookie-btn">{{ 'New Cookie'|t('pragmatic-cookies') }}</button>
  </div>

  {% if cookies|length %}
    <div class="tableview">
      <table class="data fullwidth">
        <thead>
          <tr>
            <th>{{ 'Name'|t('pragmatic-cookies') }}</th>
            <th>{{ 'Provider'|t('pragmatic-cookies') }}</th>
            <th>{{ 'Category'|t('pragmatic-cookies') }}</th>
            <th>{{ 'Duration'|t('pragmatic-cookies') }}</th>
            <th>{{ 'Regex'|t('pragmatic-cookies') }}</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for cookie in cookies %}
            <tr data-id="{{ cookie.id }}">
              <td>
                <a href="#" class="edit-cookie-btn"
                   data-id="{{ cookie.id }}"
                   data-name="{{ cookie.name }}"
                   data-provider="{{ cookie.provider }}"
                   data-description="{{ cookie.description }}"
                   data-duration="{{ cookie.duration }}"
                   data-category-id="{{ cookie.categoryId }}"
                   data-is-regex="{{ cookie.isRegex ? '1' : '0' }}">
                  {{ cookie.name }}
                </a>
              </td>
              <td>{{ cookie.provider }}</td>
              <td>
                {% set cat = categories|filter(c => c.id == cookie.categoryId)|first %}
                {{ cat ? cat.name : '—' }}
              </td>
              <td>{{ cookie.duration ?? '—' }}</td>
              <td>{{ cookie.isRegex ? 'Yes'|t('pragmatic-cookies') : 'No'|t('pragmatic-cookies') }}</td>
              <td class="thin">
                <a class="delete icon" title="{{ 'Delete'|t('pragmatic-cookies') }}" role="button" data-cookie-id="{{ cookie.id }}"></a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p>{{ 'No cookies defined yet. Add cookies manually or use the Scanner to discover them.'|t('pragmatic-cookies') }}</p>
  {% endif %}

  {# Cookie edit/create modal #}
  <div id="cookie-modal" class="modal" style="display:none;">
    <form method="post" accept-charset="UTF-8">
      {{ csrfInput() }}
      {{ actionInput('pragmatic-cookies/default/save-cookie') }}
      {{ redirectInput('pragmatic-cookies/cookies') }}

      <input type="hidden" name="cookieId" id="modal-cookie-id" value="">

      <div class="body">
        <div class="field">
          <div class="heading"><label for="modal-name">{{ 'Cookie Name'|t('pragmatic-cookies') }}</label></div>
          <div class="input"><input type="text" id="modal-name" name="name" class="text fullwidth" required></div>
        </div>

        <div class="field">
          <div class="heading"><label for="modal-provider">{{ 'Provider'|t('pragmatic-cookies') }}</label></div>
          <div class="input"><input type="text" id="modal-provider" name="provider" class="text fullwidth"></div>
        </div>

        <div class="field">
          <div class="heading"><label for="modal-category">{{ 'Category'|t('pragmatic-cookies') }}</label></div>
          <div class="input">
            <select id="modal-category" name="categoryId" class="fullwidth">
              <option value="">{{ '— Uncategorized —'|t('pragmatic-cookies') }}</option>
              {% for cat in categories %}
                <option value="{{ cat.id }}">{{ cat.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="field">
          <div class="heading"><label for="modal-description">{{ 'Description'|t('pragmatic-cookies') }}</label></div>
          <div class="input"><textarea id="modal-description" name="description" class="text fullwidth" rows="2"></textarea></div>
        </div>

        <div class="field">
          <div class="heading"><label for="modal-duration">{{ 'Duration'|t('pragmatic-cookies') }}</label></div>
          <div class="input"><input type="text" id="modal-duration" name="duration" class="text fullwidth" placeholder="{{ 'e.g. 1 year, Session'|t('pragmatic-cookies') }}"></div>
        </div>

        <div class="field">
          <div class="heading"><label>{{ 'Is Regex Pattern'|t('pragmatic-cookies') }}</label></div>
          <div class="input">
            <label><input type="checkbox" id="modal-is-regex" name="isRegex" value="1"> {{ 'Treat name as regex pattern'|t('pragmatic-cookies') }}</label>
          </div>
        </div>
      </div>

      <div class="footer">
        <div class="btngroup">
          <button type="submit" class="btn submit">{{ 'Save'|t('pragmatic-cookies') }}</button>
          <button type="button" class="btn cancel-modal">{{ 'Cancel'|t('pragmatic-cookies') }}</button>
        </div>
      </div>
    </form>
  </div>

  {% js %}
    (function() {
      var modal = document.getElementById('cookie-modal');
      var overlay = null;

      function openModal() {
        modal.style.display = 'block';
        if (!overlay) {
          overlay = document.createElement('div');
          overlay.className = 'modal-shade';
          document.body.appendChild(overlay);
        }
        overlay.style.display = 'block';
      }

      function closeModal() {
        modal.style.display = 'none';
        if (overlay) overlay.style.display = 'none';
      }

      function resetForm() {
        document.getElementById('modal-cookie-id').value = '';
        document.getElementById('modal-name').value = '';
        document.getElementById('modal-provider').value = '';
        document.getElementById('modal-category').value = '';
        document.getElementById('modal-description').value = '';
        document.getElementById('modal-duration').value = '';
        document.getElementById('modal-is-regex').checked = false;
      }

      document.getElementById('new-cookie-btn').addEventListener('click', function() {
        resetForm();
        openModal();
      });

      document.querySelectorAll('.edit-cookie-btn').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          document.getElementById('modal-cookie-id').value = this.dataset.id;
          document.getElementById('modal-name').value = this.dataset.name;
          document.getElementById('modal-provider').value = this.dataset.provider;
          document.getElementById('modal-category').value = this.dataset.categoryId;
          document.getElementById('modal-description').value = this.dataset.description;
          document.getElementById('modal-duration').value = this.dataset.duration;
          document.getElementById('modal-is-regex').checked = this.dataset.isRegex === '1';
          openModal();
        });
      });

      document.querySelectorAll('.cancel-modal').forEach(function(btn) {
        btn.addEventListener('click', closeModal);
      });

      document.querySelectorAll('.delete.icon[data-cookie-id]').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          if (!confirm({{ 'Are you sure you want to delete this cookie?'|t('pragmatic-cookies')|json_encode|raw }})) return;
          var id = this.dataset.cookieId;
          Craft.sendActionRequest('POST', 'pragmatic-cookies/default/delete-cookie', {
            data: { id: id }
          }).then(function() {
            location.reload();
          });
        });
      });
    })();
  {% endjs %}
{% endblock %}
