{% extends 'pragmatic-cookies/_layout' %}

{% set title = 'Scan Results'|t('pragmatic-cookies') %}
{% set selectedTab = 'scanner' %}
{% set _siteHandle = craft.app.request.getQueryParam('site') %}
{% set _siteParam = _siteHandle ? { site: _siteHandle } : {} %}

{% set crumbs = [
  { label: 'Cookies'|t('pragmatic-cookies'), url: url('pragmatic-cookies', _siteParam) },
  { label: 'Scanner'|t('pragmatic-cookies'), url: url('pragmatic-cookies/scanner', _siteParam) },
  { label: 'Scan Results'|t('pragmatic-cookies'), url: url('pragmatic-cookies/scanner/results/' ~ scan.id, _siteParam) },
] %}

{% block content %}
  <div class="readable">
    <p>
      <strong>{{ 'Status:'|t('pragmatic-cookies') }}</strong> {{ scan.status|capitalize }} &nbsp;|&nbsp;
      <strong>{{ 'Pages scanned:'|t('pragmatic-cookies') }}</strong> {{ scan.pagesScanned }} / {{ scan.totalPages }} &nbsp;|&nbsp;
      <strong>{{ 'Cookies found:'|t('pragmatic-cookies') }}</strong> {{ scan.cookiesFound }} &nbsp;|&nbsp;
      <strong>{{ 'Date:'|t('pragmatic-cookies') }}</strong> {{ scan.dateCreated|date('Y-m-d H:i') }}
    </p>
    {% if scan.errorMessage %}
      <p class="error">{{ scan.errorMessage }}</p>
    {% endif %}
  </div>

  {% if results|length %}
    <div class="tableview">
      <table class="data fullwidth">
        <thead>
          <tr>
            <th>{{ 'Cookie Name'|t('pragmatic-cookies') }}</th>
            <th>{{ 'Domain'|t('pragmatic-cookies') }}</th>
            <th>{{ 'Path'|t('pragmatic-cookies') }}</th>
            <th>{{ 'Found On'|t('pragmatic-cookies') }}</th>
            <th>{{ 'Linked Cookie'|t('pragmatic-cookies') }}</th>
          </tr>
        </thead>
        <tbody>
          {% for result in results %}
            <tr>
              <td><code>{{ result.cookieName }}</code></td>
              <td>{{ result.cookieDomain ?? '—' }}</td>
              <td>{{ result.cookiePath ?? '—' }}</td>
              <td>
                {% if result.pageUrl %}
                  <a href="{{ result.pageUrl }}" target="_blank" rel="noopener">{{ result.pageUrl|length > 60 ? result.pageUrl[:60] ~ '…' : result.pageUrl }}</a>
                {% else %}
                  —
                {% endif %}
              </td>
              <td>
                {% if result.cookieId %}
                  {% set linkedCookie = cookies|filter(c => c.id == result.cookieId)|first %}
                  {% if linkedCookie %}
                    <span class="status on"></span> {{ linkedCookie.name }}
                  {% else %}
                    <span class="status on"></span> {{ 'Linked'|t('pragmatic-cookies') }}
                  {% endif %}
                {% else %}
                  <select class="link-cookie-select" data-result-id="{{ result.id }}">
                    <option value="">{{ '— Link to cookie —'|t('pragmatic-cookies') }}</option>
                    {% for c in cookies %}
                      <option value="{{ c.id }}">{{ c.name }}</option>
                    {% endfor %}
                  </select>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p>{{ 'No cookies were found during this scan.'|t('pragmatic-cookies') }}</p>
  {% endif %}

  <div class="toolbar" style="margin-top: 24px;">
    <a href="{{ url('pragmatic-cookies/scanner', _siteParam) }}" class="btn">{{ 'Back to Scanner'|t('pragmatic-cookies') }}</a>
  </div>

  {% js %}
    document.querySelectorAll('.link-cookie-select').forEach(function(select) {
      select.addEventListener('change', function() {
        var cookieId = this.value;
        var resultId = this.dataset.resultId;
        if (!cookieId) return;
        Craft.sendActionRequest('POST', 'pragmatic-cookies/scan/link-cookie', {
          data: { resultId: resultId, cookieId: cookieId }
        }).then(function() {
          Craft.cp.displayNotice({{ 'Cookie linked.'|t('pragmatic-cookies')|json_encode|raw }});
        }).catch(function() {
          Craft.cp.displayError({{ 'Could not link cookie.'|t('pragmatic-cookies')|json_encode|raw }});
        });
      });
    });
  {% endjs %}
{% endblock %}
