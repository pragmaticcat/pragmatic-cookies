{% extends 'pragmatic-cookies/_layout' %}

{% set title = 'Scanner'|t('pragmatic-cookies') %}
{% set selectedTab = 'scanner' %}
{% set _siteHandle = craft.app.request.getQueryParam('site') %}
{% set _siteParam = _siteHandle ? { site: _siteHandle } : {} %}

{% set crumbs = [
  { label: 'Cookies'|t('pragmatic-cookies'), url: url('pragmatic-cookies', _siteParam) },
  { label: 'Scanner'|t('pragmatic-cookies'), url: url('pragmatic-cookies/scanner', _siteParam) },
] %}

{% do view.registerAssetBundle('pragmatic\\cookies\\assets\\CpAsset') %}

{% block content %}
  <div class="toolbar">
    <form method="post">
      {{ csrfInput() }}
      {{ actionInput('pragmatic-cookies/scan/start') }}
      {{ redirectInput('pragmatic-cookies/scanner', _siteParam) }}
      <button type="submit" class="btn submit">{{ 'Start Scan'|t('pragmatic-cookies') }}</button>
    </form>
  </div>

  <div class="readable">
    <p>{{ 'The scanner crawls your site pages using HTTP requests and detects cookies set via <code>Set-Cookie</code> headers. JavaScript-based cookies (e.g. <code>_ga</code>) are not detected and should be added manually.'|t('pragmatic-cookies')|raw }}</p>
  </div>

  {% if scans|length %}
    <div class="tableview">
      <table class="data fullwidth">
        <thead>
          <tr>
            <th>{{ 'Date'|t('pragmatic-cookies') }}</th>
            <th>{{ 'Status'|t('pragmatic-cookies') }}</th>
            <th>{{ 'Pages'|t('pragmatic-cookies') }}</th>
            <th>{{ 'Cookies Found'|t('pragmatic-cookies') }}</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for scan in scans %}
            <tr data-scan-id="{{ scan.id }}">
              <td>{{ scan.dateCreated|date('Y-m-d H:i') }}</td>
              <td>
                <span class="scan-status" data-scan-id="{{ scan.id }}">
                  {% if scan.status == 'completed' %}
                    <span class="status on"></span> {{ 'Completed'|t('pragmatic-cookies') }}
                  {% elseif scan.status == 'running' %}
                    <span class="status"></span> {{ 'Running'|t('pragmatic-cookies') }}
                    <span class="scan-progress">({{ scan.pagesScanned }}/{{ scan.totalPages }})</span>
                  {% elseif scan.status == 'pending' %}
                    <span class="status"></span> {{ 'Pending'|t('pragmatic-cookies') }}
                  {% elseif scan.status == 'failed' %}
                    <span class="status off"></span> {{ 'Failed'|t('pragmatic-cookies') }}
                  {% endif %}
                </span>
              </td>
              <td>
                <span class="scan-pages">{{ scan.pagesScanned }}</span> / {{ scan.totalPages }}
              </td>
              <td>
                <span class="scan-cookies">{{ scan.cookiesFound }}</span>
              </td>
              <td>
                {% if scan.status == 'completed' %}
                  <a href="{{ url('pragmatic-cookies/scanner/results/' ~ scan.id, _siteParam) }}" class="btn small">{{ 'View Results'|t('pragmatic-cookies') }}</a>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p>{{ 'No scans yet. Click "Start Scan" to discover cookies on your site.'|t('pragmatic-cookies') }}</p>
  {% endif %}
{% endblock %}
